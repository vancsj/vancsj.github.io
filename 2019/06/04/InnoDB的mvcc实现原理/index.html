<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"vancsj.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"remove","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":false,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="来源 简单背景介绍MySQLMySQL是现在最流行的关系型数据库(RDB)的选择, 创建一个应用时，无论是用户数据还是订单数据，使用关系型数据库存储是最可靠稳定的选择，借助RDB提供的可靠性、事务等功能，为应用提供完善的支持。MySQL是开源软件，可以免费使用，MySQL在发展多年后越来越成熟，成为大部分公司的数据库首选。MySQL采用插件式的存储引擎架构，5.5版本后默认使用InnoDB存储引擎">
<meta property="og:type" content="article">
<meta property="og:title" content="InnoDB的mvcc实现原理">
<meta property="og:url" content="https://vancsj.github.io/2019/06/04/InnoDB%E7%9A%84mvcc%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="已所欲，己所从">
<meta property="og:description" content="来源 简单背景介绍MySQLMySQL是现在最流行的关系型数据库(RDB)的选择, 创建一个应用时，无论是用户数据还是订单数据，使用关系型数据库存储是最可靠稳定的选择，借助RDB提供的可靠性、事务等功能，为应用提供完善的支持。MySQL是开源软件，可以免费使用，MySQL在发展多年后越来越成熟，成为大部分公司的数据库首选。MySQL采用插件式的存储引擎架构，5.5版本后默认使用InnoDB存储引擎">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liuzhengyang.github.io/images/mysql-arch.jpg">
<meta property="og:image" content="https://liuzhengyang.github.io/images/undolog.jpg">
<meta property="og:image" content="https://liuzhengyang.github.io/images/readview-visible.jpg">
<meta property="og:image" content="https://vancsj.github.io/images/cmake-mysql.jpg">
<meta property="og:image" content="https://liuzhengyang.github.io/2017/04/18/innodb-mvcc//images/mysql-debug.jpg">
<meta property="og:image" content="https://liuzhengyang.github.io/images/clion-mysql-debug.jpg">
<meta property="article:published_time" content="2019-06-04T08:38:41.000Z">
<meta property="article:modified_time" content="2025-06-28T14:58:54.522Z">
<meta property="article:author" content="vancsj">
<meta property="article:tag" content="锁">
<meta property="article:tag" content="并发">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="MVCC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liuzhengyang.github.io/images/mysql-arch.jpg">

<link rel="canonical" href="https://vancsj.github.io/2019/06/04/InnoDB%E7%9A%84mvcc%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>InnoDB的mvcc实现原理 | 已所欲，己所从</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">已所欲，己所从</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">己所之，己所终</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-mumbler">

    <a href="/mumbler/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>mumbler</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://vancsj.github.io/2019/06/04/InnoDB%E7%9A%84mvcc%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vancsj">
      <meta itemprop="description" content="已所欲，己所从；己所之，己所终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="已所欲，己所从">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          InnoDB的mvcc实现原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-04 16:38:41" itemprop="dateCreated datePublished" datetime="2019-06-04T16:38:41+08:00">2019-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-28 22:58:54" itemprop="dateModified" datetime="2025-06-28T22:58:54+08:00">2025-06-28</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a target="_blank" rel="noopener" href="https://liuzhengyang.github.io/2017/04/18/innodb-mvcc/">来源</a></p>
<h1 id="简单背景介绍"><a href="#简单背景介绍" class="headerlink" title="简单背景介绍"></a><a href="#" title="简单背景介绍"></a>简单背景介绍</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a><a href="#" title="MySQL"></a>MySQL</h2><p>MySQL是现在最流行的关系型数据库(RDB)的选择, 创建一个应用时，无论是用户数据还是订单数据，使用关系型数据库存储是最可靠稳定的选择，借助RDB提供的可靠性、事务等功能，为应用提供完善的支持。MySQL是开源软件，可以免费使用，MySQL在发展多年后越来越成熟，成为大部分公司的数据库首选。MySQL采用插件式的存储引擎架构，5.5版本后默认使用InnoDB存储引擎。</p>
<h2 id="MySQL架构"><a href="#MySQL架构" class="headerlink" title="MySQL架构"></a><a href="#" title="MySQL架构"></a>MySQL架构</h2><p>MySQL从概念上可以分为四层，顶层是接入层，不同语言的客户端通过mysql的协议与mysql服务器进行连接通信，接入层进行权限验证、连接池管理、线程管理等。下面是mysql服务层，包括sql解析器、sql优化器、数据缓冲、缓存等。再下面是mysql中的存储引擎层，mysql中存储引擎是基于表的。最后是系统文件层，保存数据、索引、日志等。</p>
<span id="more"></span>

<p><img src="https://liuzhengyang.github.io/images/mysql-arch.jpg" alt="mysql-arch"></p>
<h2 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a><a href="#" title="MVCC"></a>MVCC</h2><p>MVCC是Multi Version Concurrency Control的简称，代表多版本并发控制。为什么需要MVCC，还要从数据库事务的ACID特性说起。<br>相信很多朋友都了解ACID，它们分别代表了**Atomicity(原子性), Consistency(一致性), Isolation(隔离性), Durability(持久性)**。</p>
<ul>
<li><p>原子性表示一个事务的操作结果要么全部执行要么全部不执行。</p>
</li>
<li><p>一致性表示事务总是从一个一致的状态转换到另一个一致的状态。</p>
</li>
<li><p>隔离性表示一个事务的修改结果在什么时间能够被其他事务看到，SQL1992规范中对隔离性定义了不同的隔离级别，分为</p>
<ul>
<li>读未提交(READ UNCOMMITED),事务能够看到其他事务没有提及的修改，当另一个事务又回滚了修改后的情况又被称为脏读dirty read。</li>
<li>读已提交(READ COMMITTED),事务能够看到其他事务提交后的修改，这时会出现一个事务内两次读取数据可能因为其他事务提交的修改导致不一致的情况，称为不可重复读。</li>
<li>可重复读(REPEATABLE READ)，在两次读取时读取到的数据的状态是一致的。</li>
<li>序列化(SERIALIZABLE)可重复读中可能出现第二次读读到第一次没有读到的数据，也就是被其他事务插入的数据，这种情况称为幻读phantom read, 序列化级别中不能出现幻读。</li>
</ul>
</li>
</ul>
<p>隔离级别依次增强，但是导致的问题是并发能力的减弱。</p>
<p>各种数据库厂商会对各个隔离级别进行实现。</p>
<p>和Java中的多线程问题相同，数据库通常使用锁来实现隔离性。</p>
<p>最原生的锁，锁住一个资源后会禁止其他任何线程访问同一个资源。但是很多应用的一个特点都是读多写少的场景，很多数据的读取次数远大于修改的次数，而读取数据间互相排斥显得不是很必要。所以就使用了一种<strong>读写锁</strong>的方法，读锁和读锁之间不互斥，而写锁和写锁、读锁都互斥。这样就很大提升了系统的并发能力。</p>
<p>之后人们发现并发读还是不够，又提出了能不能<strong>让读写之间也不冲突</strong>的方法，就是读取数据时通过一种类似快照的方式将数据保存下来，这样读锁就和写锁不冲突了，不同的事务session会看到自己特定版本的数据。当然快照是一种概念模型，不同的数据库可能用不同的方式来实现这种功能。</p>
<p>之后的讨论默认均以REPEATABLE READ作为隔离级别。</p>
<h2 id="InnoDB与MVCC"><a href="#InnoDB与MVCC" class="headerlink" title="InnoDB与MVCC"></a><a href="#" title="InnoDB与MVCC"></a>InnoDB与MVCC</h2><p>MySQL中的InnoDB存储引擎的特性有，默认隔离级别REPEATABLE READ, 行级锁，实现了MVCC, Consistent nonlocking read(默认读不加锁，一致性非锁定读), Insert Buffer, Adaptive Hash Index, DoubleWrite, Cluster Index。</p>
<p>上面列举了这么多，表示InnoDB有很多特性、很快。</p>
<p>InnoDB中通过UndoLog实现了数据的多版本，而并发控制通过锁来实现。</p>
<p>Undo Log除了实现MVCC外，还用于事务的回滚。</p>
<h2 id="Redo-log-Bin-log-Undo-log"><a href="#Redo-log-Bin-log-Undo-log" class="headerlink" title="Redo log, Bin log, Undo log"></a><a href="#" title="Redo log, bin log, Undo log"></a>Redo log, Bin log, Undo log</h2><p>MySQL Innodb中存在多种日志，除了错误日志、查询日志外，还有很多和数据持久性、一致性有关的日志。</p>
<p>Binlog，是mysql服务层产生的日志，常用来进行数据恢复、数据库复制，常见的mysql主从架构，就是采用slave同步master的binlog实现的, 另外通过解析binlog能够实现mysql到其他数据源（如ElasticSearch)的数据复制。</p>
<p>Redo log记录了数据操作在物理层面的修改，mysql中使用了大量缓存，缓存存在于内存中，修改操作时会直接修改内存，而不是立刻修改磁盘，当内存和磁盘的数据不一致时，称内存中的数据为**脏页(dirty page)**。为了保证数据的安全性，事务进行中时会不断的产生redo log，在事务提交时进行一次flush操作，保存到磁盘中, redo log是按照顺序写入的，磁盘的顺序读写的速度远大于随机读写。当数据库或主机失效重启时，会根据redo log进行数据的恢复，如果redo log中有事务提交，则进行事务提交修改数据。这样实现了事务的原子性、一致性和持久性。</p>
<p>Undo Log: 除了记录redo log外，当进行数据修改时还会记录undo log，undo log用于数据的撤回操作，它记录了修改的反向操作，比如，插入对应删除，修改对应修改为原来的数据，通过undo log可以实现事务回滚，并且可以<strong>根据undo log回溯到某个特定的版本的数据，实现MVCC</strong>。</p>
<p>redo log 和binlog的一致性，为了防止写完binlog但是redo log的事务还没提交导致的不一致，innodb 使用了两阶段提交大致执行序列为</p>
<ul>
<li>InnoDB prepare  （持有prepare_commit_mutex）；</li>
<li>write/sync Binlog；</li>
<li>InnoDB commit (写入COMMIT标记后释放prepare_commit_mutex)。</li>
</ul>
<h2 id="MVCC实现"><a href="#MVCC实现" class="headerlink" title="MVCC实现"></a><a href="#" title="MVCC实现"></a>MVCC实现</h2><p>innodb中通过B+树作为索引的数据结构，并且主键所在的索引为ClusterIndex(聚簇索引), ClusterIndex中的叶子节点中保存了对应的数据内容。一个表只能有一个主键，所以只能有一个聚簇索引，<strong>如果表没有定义主键，则选择第一个非NULL唯一索引作为聚簇索引</strong>，如果还没有则生成一个隐藏id列作为聚簇索引。</p>
<p>除了Cluster Index外的索引是Secondary Index(辅助索引)。辅助索引中的叶子节点保存的是聚簇索引的叶子节点的值。</p>
<p>InnoDB行记录中除了刚才提到的rowid外，还有<strong>trx_id和db_roll_ptr, trx_id表示最近修改的事务的id,db_roll_ptr指向undo segment中的undo log</strong>。</p>
<p>新增一个事务时事务id会增加，<strong>trx_id能够表示事务开始的先后顺序</strong>。</p>
<p>Undo log分为Insert和Update两种，delete可以看做是一种特殊的update，即在记录上修改删除标记。<br>update undo log记录了数据之前的数据信息，通过这些信息可以还原到之前版本的状态。</p>
<p>当进行插入操作时，生成的Insert undo log在事务提交后即可删除，因为其他事务不需要这个undo log。</p>
<p>进行删除修改操作时，会生成对应的undo log，并将当前数据记录中的db_roll_ptr指向新的undo log<br><img src="https://liuzhengyang.github.io/images/undolog.jpg" alt="undolog"></p>
<h3 id="数据可见性判断"><a href="#数据可见性判断" class="headerlink" title="数据可见性判断"></a><a href="#" title="数据可见性判断"></a>数据可见性判断</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `testunique` (</span><br><span class="line"></span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">  `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line"></span><br><span class="line">  `ukey` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line"></span><br><span class="line">  KEY `id_uid` (`uid`),</span><br><span class="line"></span><br><span class="line">  KEY `index_key` (`ukey`)</span><br><span class="line"></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">70</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<p>隔离级别REPEATABLE READ</p>
<table>
<thead>
<tr>
<th align="left">session1</th>
<th align="left">session2</th>
</tr>
</thead>
<tbody><tr>
<td align="left">begin;</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">select * from testunique;</td>
</tr>
<tr>
<td align="left">insert into testunique values(NULL, NULL, 1);</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">select * from testunique;</td>
</tr>
<tr>
<td align="left">commit</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">select * from testunique;</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">commit</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">select * from testunique;</td>
</tr>
</tbody></table>
<p>只有当session2 commit之后的查询才能查到session1插入的数据</p>
<p>事务可见性的处理过程:</p>
<p><img src="https://liuzhengyang.github.io/images/readview-visible.jpg" alt="undo-view"></p>
<p>RR级别下一个事务开始后第一个snapshot read的时候，会将当期活动的事务id记录下来，记录到read view中。RC级别则是每次snapshot read都会创建一个新的read view。<br>假设当前,read view中最大的事务id为tmax, 最小为tmin。则判断一个数据是否可见以及对应的版本的方法为。<br>如果该行中的trx_id, 赋值给tid, 如果tid和当前事务id相等或小于tmin，说明是事务内发生的或开启前的修改，则直接返回该版本数据; 如果<br>trx_id大于tmax, 则查看该版本的db_roll_ptr中的trx_id，赋值给tid并从头开始判断。如果tid小于tmax并且不在read view中，则返回，否则中回滚段中找出undo log的trx_id，赋值给tid从头判断。</p>
<p>所以可见性是，只有当第一次读之前提交的修改和自己的修改可见，其他的均不可见。</p>
<h2 id="代码实现部分"><a href="#代码实现部分" class="headerlink" title="代码实现部分"></a><a href="#" title="代码实现部分"></a>代码实现部分</h2><p>在storage/innobase/include/read0types.h中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Friend declaration</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MVCC</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Read view lists the trx ids of those transactions for which a consistent</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">read should not see the modifications to the database. */</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadView</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    private:</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prevent copying</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ids_t</span>(<span class="type">const</span> <span class="type">ids_t</span>&amp;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ids_t</span>&amp; operator=(<span class="type">const</span> <span class="type">ids_t</span>&amp;);</span><br><span class="line"></span><br><span class="line">    private:</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Memory for the array */</span></span><br><span class="line"></span><br><span class="line">        value_type* m_ptr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Number of active elements in the array */</span></span><br><span class="line"></span><br><span class="line">        ulint       m_size;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Size of m_ptr in elements */</span></span><br><span class="line"></span><br><span class="line">        ulint       m_reserved;</span><br><span class="line"></span><br><span class="line">        friend <span class="class"><span class="keyword">class</span> <span class="title">ReadView</span>;</span></span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">    ReadView();</span><br><span class="line"></span><br><span class="line">    ~ReadView();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Check whether transaction id is valid.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param[in]  id      transaction id to check</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param[in]  name        table name */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">void</span> <span class="title function_">check_trx_id_sanity</span><span class="params">(</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        <span class="type">trx_id_t</span>        id,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">table_name_t</span>&amp; name)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断一个修改是否可见</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Check whether the changes by id are visible.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param[in]  id  transaction id to check against the view</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param[in]  name    table name</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return whether the view sees the modifications of id. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">changes_visible</span><span class="params">(</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        <span class="type">trx_id_t</span>        id,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">table_name_t</span>&amp; name)</span> <span class="type">const</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">MY_ATTRIBUTE</span><span class="params">((warn_unused_result))</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ut_ad(id &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id &lt; m_up_limit_id || id == m_creator_trx_id) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        check_trx_id_sanity(id, name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id &gt;= m_low_limit_id) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m_ids.empty()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">ids_t</span>::value_type*    p = m_ids.data();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>(!<span class="built_in">std</span>::binary_search(p, p + m_ids.size(), id));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disable copying</span></span><br><span class="line"></span><br><span class="line">    ReadView(<span class="type">const</span> ReadView&amp;);</span><br><span class="line"></span><br><span class="line">    ReadView&amp; operator=(<span class="type">const</span> ReadView&amp;);</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 活动事务中的id的最大</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The read should not see any transaction with trx id &gt;= this</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> value. In other words, this is the &quot;high water mark&quot;. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">trx_id_t</span>    m_low_limit_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 活动事务id的最小值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The read should see all trx ids which are strictly</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> smaller (&lt;) than this value.  In other words, this is the</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> low water mark&quot;. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="type">trx_id_t</span>    m_up_limit_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** trx id of creating transaction, set to TRX_ID_MAX for free</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> views. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">trx_id_t</span>    m_creator_trx_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Set of RW transactions that was active when this snapshot</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> was taken */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ids_t</span>       m_ids;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The view does not need to see the undo logs for transactions</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> whose transaction number is strictly smaller (&lt;) than this value:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> they can be removed in purge if not needed by other views */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">trx_id_t</span>    m_low_limit_no;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** AC-NL-RO transaction view that has been &quot;closed&quot;. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span>        m_closed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typedef</span> <span class="title function_">UT_LIST_NODE_T</span><span class="params">(ReadView)</span> <span class="type">node_t</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** List of read views in trx_sys */</span></span><br><span class="line"></span><br><span class="line">    byte        pad1[<span class="number">64</span> - <span class="keyword">sizeof</span>(<span class="type">node_t</span>)];</span><br><span class="line"></span><br><span class="line">    <span class="type">node_t</span>      m_view_list;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Undo-log删除"><a href="#Undo-log删除" class="headerlink" title="Undo log删除"></a><a href="#" title="Undo log删除"></a>Undo log删除</h3><p>undo log在没有活动事务依赖（用于consistent read或回滚)便可以清楚，innodb 中存在后台purge 线程进行后台轮询删除undo log。</p>
<h2 id="Current-Read-snapshot-read"><a href="#Current-Read-snapshot-read" class="headerlink" title="Current Read snapshot read"></a><a href="#" title="Current Read snapshot read"></a>Current Read snapshot read</h2><p>REPEATABLE READ隔离级别下普通的读操作即select都不加锁，使用MVCC进行一致性读取，这种读取又叫做snapshot read。<br>而update, insert, delete, select … for update, select … lock in share mode都会进行加锁，并且读取的是当前版本，也就是READ COMMITTED读的效果。<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html">innodb-locks-set.html</a>中对各种操作会进行的锁操作有详细的说明，这里我简单总结下。<br>InnoDB中加锁的方法是锁住对应的索引，一个操作进行前会选择一个索引进行扫描，扫描到一行后加上对应的锁然后返回给上层然后继续扫描。I<br>nnoDB支持行级锁(record lock)，上述需要加锁的操作中，除了select … lock in share mode 是加shared lock（共享锁或读锁）外其他操作都加的是exclusive lock(即排他锁或写锁)。在加行级锁前，会对表加一个intention lock，即意向锁，意向所是表级锁，不会和行级锁冲突，主要用途是表明一个要加行级锁或正在加锁的操作。<br>另外InnoDB种除了record lock外还有一种gap lock，即锁住两个记录间的间隙，防止其他事务插入数据，用于防止幻读。当索引是主键索引或唯一索引时，不需要加gap lock。当索引不是唯一索引时，需要对索引数据和索引前的gap加锁，这种方式叫做next-key locking。<br>另外在插入数据时，还需要提前最插入行的前面部分加上insert intention lock, 即插入意向锁，插入意向锁之间不会冲突，会和gap锁冲突导致等待。当插入时遇到duplicated key错误时，会在要插入的行上加上share lock。</p>
<h2 id="Mac下Debug-mysql"><a href="#Mac下Debug-mysql" class="headerlink" title="Mac下Debug mysql"></a><a href="#" title="Mac下Debug mysql"></a>Mac下Debug mysql</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git clone https://[github.com/mysql/mysql\-server](http://github.com/mysql/mysql-server)</span><br><span class="line"></span><br><span class="line">cd mysql-server</span><br><span class="line"></span><br><span class="line">mkdir bld</span><br><span class="line"></span><br><span class="line">cd bld</span><br><span class="line"></span><br><span class="line">cmake .. -DWITH_DEBUG=1 -DDOWNLOAD_BOOST=1 -DWITH_BOOST=~/boost</span><br></pre></td></tr></table></figure>

<p>Clion中debug<br>下载最新版本的Clion,<br>import project 打开mysql-server文件夹<br>配置cmake 参数 CMakeOptions为</p>
<p>-DDOWNLOAD_BOOST=1 -DWITH_BOOST=~/boost</p>
<p><img src="/images/cmake-mysql.jpg" alt="cmake-mysql"><br>之后Clion自动进行cmake<br>结束后可以看到有很多可以debug的程序<br><img src="https://liuzhengyang.github.io/2017/04/18/innodb-mvcc//images/mysql-debug.jpg" alt="mysql-debug"><br>选择mysqld，即为mysql服务器程序<br>入口在sql/main.cc<br>加上断点, 点击debug后，经过一段时间build，即可进行debug了<br><img src="https://liuzhengyang.github.io/images/clion-mysql-debug.jpg" alt="clion-mysql-debug"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a><a href="#" title="参考"></a>参考</h1><ul>
<li>  <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html</a></li>
<li>  <a target="_blank" rel="noopener" href="http://hedengcheng.com/">http://hedengcheng.com/</a></li>
<li>  MySQL技术内幕</li>
<li>  <a target="_blank" rel="noopener" href="http://www.postgres.cn/downfiles/pg2016conf_day2_s1_pm3.pdf">http://www.postgres.cn/downfiles/pg2016conf_day2_s1_pm3.pdf</a></li>
<li>  <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/source-installation.html">https://dev.mysql.com/doc/refman/5.7/en/source-installation.html</a></li>
<li>  <a target="_blank" rel="noopener" href="https://blog.jcole.us/2014/04/16/the-basics-of-the-innodb-undo-logging-and-history-system/">https://blog.jcole.us/2014/04/16/the-basics-of-the-innodb-undo-logging-and-history-system/</a></li>
<li>  <a target="_blank" rel="noopener" href="http://www.cnblogs.com/chenpingzhao/p/5065316.html">http://www.cnblogs.com/chenpingzhao/p/5065316.html</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%94%81/" rel="tag"># 锁</a>
              <a href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag"># 并发</a>
              <a href="/tags/MySQL/" rel="tag"># MySQL</a>
              <a href="/tags/MVCC/" rel="tag"># MVCC</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/06/04/kafka%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95/" rel="prev" title="kafka时间轮算法">
      <i class="fa fa-chevron-left"></i> kafka时间轮算法
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/06/04/Java%E7%9A%84wait-notify%E6%9C%BA%E5%88%B6/" rel="next" title="Java的wait-notify机制">
      Java的wait-notify机制 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">vancsj</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
